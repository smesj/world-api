// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================================================
// IDENTITY DOMAIN
// ==============================================================================

// User model - synced from Clerk via webhook
model User {
  id                String   @id // Clerk user ID
  username          String   @unique
  firstName         String?
  lastName          String?
  imageUrl          String?

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastSignInAt      DateTime?

  // Relations
  createdInvitations Invitation[]  @relation("CreatedBy")
  imperialGames      ImperialGame[]
  imperialScores     ImperialScore[]
  gameParticipations GameParticipation[]

  @@index([username])
}

// Invitation model - for invite-only access
model Invitation {
  id          String    @id @default(uuid())
  code        String    @unique @default(cuid())

  // Usage tracking
  maxUses     Int       @default(1)
  usesCount   Int       @default(0)

  // Created by
  createdById String?
  createdBy   User?     @relation("CreatedBy", fields: [createdById], references: [id])

  // Expiration
  expiresAt   DateTime?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
}

// ==============================================================================
// GAMES DOMAIN (Multi-Game Architecture)
// ==============================================================================

// Base games table - central table for all game types
model Game {
  id        Int      @id @default(autoincrement())
  type      GameType @default(FOOTY)
  status    GameStatus @default(PENDING)
  seasonId  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participations GameParticipation[]
  footyGame      FootyGame?

  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// Junction table linking users to games with game-specific player metadata
model GameParticipation {
  id           Int     @id @default(autoincrement())
  gameId       Int
  userId       String  // Clerk user ID
  role         String  // 'team_a', 'team_b', 'player_1', etc.
  stats        Json?   // Flexible JSON for game-specific stats

  // Relations
  game         Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId, role]) // Prevent duplicate participations
  @@index([userId])
  @@index([gameId])
}

// Game types enum
enum GameType {
  FOOTY
  IMPERIAL
  // Future: CHESS, etc.
}

// Game status enum
enum GameStatus {
  PENDING
  ACTIVE
  COMPLETED
  ABANDONED
}

// ==============================================================================
// FOOTY DOMAIN (Table Football)
// ==============================================================================

// Footy-specific game data
model FootyGame {
  id            Int      @id @default(autoincrement())
  gameId        Int      @unique
  scoreTeamA    Int      @default(0)
  scoreTeamB    Int      @default(0)
  duration      Int      @default(360000) // 6 minutes in milliseconds

  // Relations
  game          Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
}

// ==============================================================================
// IMPERIAL DOMAIN (Board Game)
// ==============================================================================

// Imperial game session
model ImperialGame {
  id           String          @id @default(uuid())

  // Game details
  status       String          @default("in_progress") // in_progress, completed, abandoned

  // Created by
  createdById  String
  createdBy    User            @relation(fields: [createdById], references: [id])

  // Relations
  scores       ImperialScore[]

  // Metadata
  startedAt    DateTime        @default(now())
  completedAt  DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([createdById])
  @@index([status])
}

// Imperial player score in a game
model ImperialScore {
  id           String        @id @default(uuid())

  // Game reference
  gameId       String
  game         ImperialGame  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  // Player reference
  playerId     String
  player       User          @relation(fields: [playerId], references: [id])

  // Score details
  nation       String        // Which nation the player controlled
  finalScore   Int           @default(0)
  position     Int?          // Final position (1st, 2nd, etc.)

  // Metadata
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([gameId, playerId])
  @@index([gameId])
  @@index([playerId])
}
