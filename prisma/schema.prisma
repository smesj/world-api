// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================================================
// IDENTITY DOMAIN
// ==============================================================================

// User model - synced from Clerk via webhook
model User {
  id                String   @id // Clerk user ID
  username          String   @unique
  firstName         String?
  lastName          String?
  imageUrl          String?

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastSignInAt      DateTime?

  // Relations
  createdInvitations Invitation[]  @relation("CreatedBy")
  footyGames         FootyGame[]
  imperialGames      ImperialGame[]
  imperialScores     ImperialScore[]

  @@index([username])
}

// Invitation model - for invite-only access
model Invitation {
  id          String    @id @default(uuid())
  code        String    @unique @default(cuid())

  // Usage tracking
  maxUses     Int       @default(1)
  usesCount   Int       @default(0)

  // Created by
  createdById String?
  createdBy   User?     @relation("CreatedBy", fields: [createdById], references: [id])

  // Expiration
  expiresAt   DateTime?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
}

// ==============================================================================
// FOOTY DOMAIN (Table Football)
// ==============================================================================

// Footy game session - tracks a table football match
model FootyGame {
  id           String    @id @default(uuid())

  // Game details
  team1Player1 String
  team1Player2 String?   // Optional for 2v2
  team2Player1 String
  team2Player2 String?   // Optional for 2v2

  team1Score   Int       @default(0)
  team2Score   Int       @default(0)

  // Game state
  status       String    @default("in_progress") // in_progress, completed, abandoned

  // Timer data (stored for historical purposes)
  duration     Int?      // Duration in seconds

  // Created by
  createdById  String
  createdBy    User      @relation(fields: [createdById], references: [id])

  // Metadata
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([createdById])
  @@index([status])
}

// ==============================================================================
// IMPERIAL DOMAIN (Board Game)
// ==============================================================================

// Imperial game session
model ImperialGame {
  id           String          @id @default(uuid())

  // Game details
  status       String          @default("in_progress") // in_progress, completed, abandoned

  // Created by
  createdById  String
  createdBy    User            @relation(fields: [createdById], references: [id])

  // Relations
  scores       ImperialScore[]

  // Metadata
  startedAt    DateTime        @default(now())
  completedAt  DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([createdById])
  @@index([status])
}

// Imperial player score in a game
model ImperialScore {
  id           String        @id @default(uuid())

  // Game reference
  gameId       String
  game         ImperialGame  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  // Player reference
  playerId     String
  player       User          @relation(fields: [playerId], references: [id])

  // Score details
  nation       String        // Which nation the player controlled
  finalScore   Int           @default(0)
  position     Int?          // Final position (1st, 2nd, etc.)

  // Metadata
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([gameId, playerId])
  @@index([gameId])
  @@index([playerId])
}
