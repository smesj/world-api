# World API - Claude Context

## Project Overview

**World API** is a unified NestJS backend that consolidates all smesj ecosystem applications into a single modular monolith. This architecture replaces separate microservices with domain-specific modules while maintaining clear boundaries and separation of concerns.

- **Repository**: world-api
- **Domain**: world-api.smesj.world
- **Port**: 3003
- **Database**: Single PostgreSQL database with logical domain separation
- **Architecture**: Modular monolith with four main modules (Identity, Footy, Imperial, Webhooks)

## Architecture Decision

This project was created to replace a microservices architecture with a modular monolith based on:

- Solo developer context (just smesj)
- Small scale operation (friends/family)
- 100% user overlap across all apps
- Tightly related domains
- Need for fast iteration
- Benefits: shared transactions, type safety, simpler operations
- Can split into microservices later if needed

## Domain Modules

### 1. Identity Module (`src/modules/identity`)

**Purpose**: User management and invitation code system

**Ported from**: world-identity-api

**Components**:
- `invitations.controller.ts` - REST endpoints for invitation management
- `invitations.service.ts` - Business logic for invitation codes
- `invitations.dto.ts` - DTOs for request validation

**Key Features**:
- Create invitation codes with expiration
- Validate invitation codes
- Use invitation codes (increment usage count)
- Generate QR codes for signup URLs
- Admin endpoints for listing/managing invitations

**API Endpoints**:
```
POST   /invitations             - Create new invitation
POST   /invitations/validate    - Validate invitation code
POST   /invitations/use         - Mark invitation as used
GET    /invitations/:code/qr    - Generate QR code
GET    /invitations             - List all invitations (admin)
GET    /invitations/:id         - Get specific invitation
DELETE /invitations/:id         - Delete invitation
```

**Database Models**:
- `User` - Clerk user information
- `Invitation` - Invitation codes with usage tracking

### 2. Footy Module (`src/modules/footy`)

**Purpose**: Table football timer and game tracking

**Ported from**: table-footy-api

**Components**:
- `timer.controller.ts` - REST endpoints for timer management
- `timer.service.ts` - Timer logic with in-memory caching
- `timer.gateway.ts` - WebSocket gateway for real-time updates
- `footy.module.ts` - Module with cache and WebSocket setup

**Key Features**:
- 6-minute countdown timers
- Start/pause/stop/reset functionality
- Real-time WebSocket updates
- In-memory cache for timer state
- Room-based subscriptions per timer

**API Endpoints**:
```
POST   /footy/timer/:id/start   - Start timer
POST   /footy/timer/:id/pause   - Pause timer
POST   /footy/timer/:id/stop    - Stop timer
POST   /footy/timer/:id/reset   - Reset timer
GET    /footy/timer/:id         - Get timer state
```

**WebSocket Events**:
```
subscribe        - Join timer room
unsubscribe      - Leave timer room
timerUpdate      - Receive timer updates
```

**Database Models**:
- `FootyGame` - Game records with scores and players

### 3. Imperial Module (`src/modules/imperial`)

**Purpose**: Imperial board game tracking and leaderboards

**Status**: Scaffolded (not yet implemented in any existing service)

**Components**:
- `games.controller.ts` - REST endpoints for game management
- `games.service.ts` - Business logic for games and scores
- `games.dto.ts` - DTOs for request validation

**Planned Features**:
- Create Imperial games
- Track player scores by nation
- Maintain leaderboards
- Complete/abandon games
- Historical game data

**API Endpoints**:
```
POST   /imperial/games                - Create new game
GET    /imperial/games                - List all games
GET    /imperial/games/:id            - Get game details
PATCH  /imperial/games/:id            - Update game status
DELETE /imperial/games/:id            - Delete game
POST   /imperial/games/:id/scores     - Add/update player score
GET    /imperial/games/:id/leaderboard - Get game leaderboard
```

**Database Models**:
- `ImperialGame` - Game sessions
- `ImperialScore` - Player scores per game

### 4. Webhooks Module (`src/modules/webhooks`)

**Purpose**: Clerk user synchronization via webhooks

**Ported from**: world-identity-api

**Components**:
- `webhooks.controller.ts` - Webhook endpoint for Clerk events
- `webhooks.service.ts` - Webhook validation and event handling

**Key Features**:
- Svix signature verification for security
- Automatic user creation from Clerk
- User profile updates when changed in Clerk
- User deletion when removed from Clerk
- Graceful handling of missing webhook secret (dev mode)

**API Endpoints**:
```
POST   /webhooks/clerk    - Receive Clerk webhook events
```

**Webhook Events Handled**:
- `user.created` - Creates new User record in database
- `user.updated` - Updates existing User record (or creates if missing)
- `user.deleted` - Removes User record from database

**Security**:
- Validates Svix signature headers (svix-id, svix-timestamp, svix-signature)
- Rejects requests with invalid signatures
- Logs all webhook events for debugging

**Configuration**:
- Environment variable: `CLERK_WEBHOOK_SECRET`
- If not set, validation is disabled (dev only - warning logged)

## Shared Infrastructure

### PrismaService (`src/shared/prisma.service.ts`)

Shared Prisma client used across all modules:
- Connects on module initialization
- Provides unified database access
- Handles graceful shutdown

### Database Schema (`prisma/schema.prisma`)

Single unified schema with logical domain separation:

**Identity Domain**:
- `User` - Central user model (Clerk ID as primary key)
- `Invitation` - Invitation code management

**Footy Domain**:
- `FootyGame` - Table football game records

**Imperial Domain**:
- `ImperialGame` - Imperial game sessions
- `ImperialScore` - Player scores per game

All models connect through the central `User` model for consistent user references.

## Technology Stack

- **Framework**: NestJS 10.x
- **Runtime**: Node.js 18 (Alpine Linux)
- **Database**: PostgreSQL with Prisma ORM
- **WebSocket**: Socket.io for real-time updates
- **Caching**: In-memory cache manager
- **Validation**: class-validator, class-transformer
- **QR Codes**: qrcode library
- **Webhooks**: Svix for Clerk webhook verification
- **CORS**: Enabled for wildcard origins

## Deployment

### Docker Configuration

**Dockerfile**:
- Multi-stage build (build + prod)
- Platform: linux/amd64
- Prisma generation at build time
- Production dependencies only in final image
- Runs migrations on startup

**Environment Variables**:
```bash
PORT=3003
DATABASE_URL="postgresql://world:PASSWORD@localhost:5434/world_api"
NODE_ENV=production
CLERK_WEBHOOK_SECRET=whsec_your_production_webhook_secret_here
```

### Deployment Script (`deploy.sh`)

Automated deployment to production VM:

1. **Build**: Docker image with multi-stage build
2. **Push**: To Docker Hub (smesjman/world-api)
3. **Deploy**: SSH to VM at 172.16.1.244
4. **Run**: Container with restart policy
5. **Migrations**: Automatically run via Dockerfile CMD on startup
6. **Link**: To world-postgres database container
7. **Verify**: Check migrations, app startup, and /invitations endpoint

**Usage**:
```bash
./deploy.sh           # Deploy as 'latest'
./deploy.sh v1.0.0    # Deploy with version tag
```

**Production Setup**:
- Container name: world-api
- Port mapping: 3003:3003
- Restart policy: unless-stopped
- Database link: world-postgres
- Env file: /home/smesj/world-api/.env.production

**Migration Process**:
- Migrations run automatically on container startup via Dockerfile CMD
- Command: `npx prisma migrate deploy && node dist/src/main`
- Deploy script verifies migrations completed successfully
- If migrations fail, container won't start (fail-fast approach)
- Check migration logs: `ssh smesj@172.16.1.244 'docker logs world-api | grep -A5 prisma'`

### Cloudflare Tunnel

API accessible via: https://world-api.smesj.world

## Development

### Local Setup

```bash
# Install dependencies
npm install

# Set up environment
cp .env.example .env

# Run database migrations
npx prisma migrate dev

# Generate Prisma client
npx prisma generate

# Start development server
npm run start:dev
```

### Database Management

**Migration Workflow** (Important - Follow This Process):

Due to non-interactive shell limitations in Claude Code, migrations must be run manually:

1. Claude modifies `schema.prisma` with new/updated models
2. User runs: `npx prisma migrate dev --name <description>`
3. Claude verifies migration success with database queries if needed

This creates proper migration files in `prisma/migrations/` and applies them to the database.

**Other Database Commands**:
```bash
# Apply production migrations
npx prisma migrate deploy

# View database in Prisma Studio
npx prisma studio

# Reset database (dev only)
npx prisma migrate reset
```

**Note**: Never use `npx prisma db push` for migrations. It skips creating migration files which breaks production deployments.

### Module Structure

Each module follows this pattern:
```
src/modules/<domain>/
├── <domain>.module.ts          # Module definition
├── <feature>.controller.ts     # REST endpoints
├── <feature>.service.ts        # Business logic
├── <feature>.dto.ts            # Request/response DTOs
└── <feature>.gateway.ts        # WebSocket (if needed)
```

## Migration Planning

### Current State

- Identity functionality: Ported from world-identity-api ✓
- Footy timer: Ported from table-footy-api ✓
- Webhooks: Ported from world-identity-api ✓
- Imperial: Scaffolded, not yet implemented

### Migration TODO (Not Yet Started)

**Data Migration**:
1. Export data from world-identity-api database
2. Export data from table-footy-api database
3. Transform data to match unified schema
4. Import into world-api database
5. Verify data integrity

**Frontend Migration**:
1. Update footy.smesj.world to use world-api endpoints
2. Update API base URL configuration
3. Test all existing functionality
4. Deploy updated frontend
5. Monitor for errors

**Cleanup**:
1. Keep old APIs running temporarily
2. Monitor traffic to ensure cutover is complete
3. Archive old API repositories
4. Decommission old database containers

**Note**: Migration planning has been explicitly deferred until infrastructure is complete.

## Inter-Module Communication

All modules export their services for cross-module use:

```typescript
// identity.module.ts
@Module({
  providers: [InvitationsService, PrismaService],
  exports: [InvitationsService],  // Available to other modules
})

// Using in another module
constructor(
  private invitationsService: InvitationsService,
) {}
```

## API Conventions

### Response Formats

**Success**:
```json
{
  "id": "uuid",
  "field": "value",
  ...
}
```

**Error**:
```json
{
  "statusCode": 400,
  "message": "Error description",
  "error": "Bad Request"
}
```

### Validation

All endpoints use DTOs with class-validator decorators:
- `@IsString()`, `@IsInt()`, `@IsOptional()`, etc.
- Automatic validation via global ValidationPipe
- Whitelist mode (strip unknown properties)
- Transform mode (convert types)

### Authentication

Currently, no authentication middleware is implemented. User IDs are passed in request bodies. Future implementation should:
1. Add Clerk JWT validation middleware
2. Extract user ID from JWT
3. Inject user context into requests
4. Protect endpoints with guards

## Testing

### Unit Tests

```bash
npm run test              # Run tests
npm run test:watch        # Watch mode
npm run test:cov          # With coverage
```

### E2E Tests

```bash
npm run test:e2e
```

## Known Issues

None at this time. This is a fresh implementation.

## Future Enhancements

1. **Authentication**: Implement Clerk JWT validation
2. **Authorization**: Role-based access control
3. **Rate Limiting**: Protect public endpoints
4. **Logging**: Structured logging with Winston
5. **Monitoring**: Health checks and metrics
6. **API Documentation**: Swagger/OpenAPI
7. **Testing**: Comprehensive test coverage
8. **Imperial Module**: Complete implementation
9. **Footy Games**: Implement game tracking (currently only timer exists)
10. **WebSocket Auth**: Secure WebSocket connections

## Related Services

- **Footy Frontend**: footy.smesj.world (React)
- **Table Footy Frontend**: table-footy.smesj.world (React)
- **Imperial Frontend**: imperial.smesj.world (React)
- **Database**: world-postgres container on VM
- **Old APIs**: world-identity-api, table-footy-api (to be deprecated)

## Support

For issues or questions, contact smesj or check the deployment logs:

```bash
ssh smesj@172.16.1.244 'docker logs world-api'
```
